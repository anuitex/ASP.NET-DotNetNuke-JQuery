@inherits System.Web.Mvc.WebViewPage<RazorCart.AdminConsole.Models.ExtensionModel>
@using System.Web.Mvc.Html;

<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Extensibility Setup</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
<div class="row">
    <div class="col-lg-12">
        <form class="form-horizontal" method="post" action="@Url.Action("Save", "Extension", new { StoreID = Model.StoreID })" autocomplete="off">
            @if (Model.Submitted)
            {
                <div class="alert alert-success alert-dismissable">
                    <span class="close" data-dismiss="alert" aria-label="close">×</span>
                    @Model.SaveMessage
                </div>
            }
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4>Action Delegate Pipeline</h4>
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">
                    <div class="form-group">
                        <label class="col-md-3 col-sm-4 control-label">Integration Namespace</label>
                        <div class="col-md-6 col-sm-8">
                            @Html.DropDownList("IntegrationNamespace", Model.ExtendedAssemblies, "-- No Integration --", new { @class = "form-control" })
                        </div>
                    </div>
                    @if (Model.IsActiveAssembly)
                    {
                        <div class="form-group">
                            <label class="col-md-3 col-sm-4 control-label">Active Pipeline Actions</label>
                            <div class="col-md-6 col-sm-8">
                                @Html.DropDownList("PipelineActions", Model.AssemblyDefinedTypes, new { @class = "form-control", @multiple = "multiple", @disabled = "disabled", @size = "10" })
                            </div>
                        </div>
                    }
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4>Extensions</h4>
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="table-sortable">
                            <thead>
                                <tr>
                                    <th>Active</th>
                                    <th>Name</th>
                                    <th>Pipeline Action</th>
                                    <th>Run Event(s)</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var extension in Model.Extensions)
                                {
                                    <tr>
                                        <td>
                                            <div class="checkbox">
                                                <label @if (extension.InUse) { <text>data-toggle="tooltip" data-placement="right" title="Extension already in use!"</text> }>
                                                    <input type="checkbox" value="@extension.AssemblyQualifiedName" onchange="setActiveExtensions(this);" @(extension.Active ? "checked" : "") @(extension.InUse ? "disabled" : "") />
                                                    <span class="rc-control">
                                                        <i class="rc-icon glyphicon glyphicon-checkbox" aria-hidden="true"></i>
                                                    </span>
                                                </label>
                                            </div>
                                        </td>
                                        <td>@extension.FullName</td>
                                        <td>@extension.PipelineAction</td>
                                        <td>@string.Join(", ", extension.RunEvents)</td>
                                        <td class="text-right">
                                            @if (extension.Active)
                                            {
                                                <a href="@Url.Action("Edit", "Extension", new { StoreID = Model.StoreID, Name = HttpServerUtility.UrlTokenEncode(System.Text.Encoding.UTF8.GetBytes(extension.AssemblyQualifiedName)) })">
                                                    <i class="fa fa-cog fa-lg"></i>
                                                </a>
                                            }
                                        </td>
                                    </tr>
                                }
                                @if (Model.Extensions.Count < 1)
                                {
                                    <tr><td colspan="4">No Extensions added.</td></tr>
                                }
                            </tbody>
                        </table>
                        @Html.Hidden("ActiveExtensions", Json.Encode(Model.Extensions.Where(e => e.Active && !e.InUse).Select(e => e.AssemblyQualifiedName).ToArray()))
                    </div>
                    <!-- /.table-responsive -->
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
            <div class="form-group">
                <div class="col-sm-offset-3 col-sm-9">
                    <button type="submit" class="btn btn-primary"><i class="fa fa-check-square-o"></i> Save</button>
                </div>
            </div>
        </form>
        <!-- /.form -->
    </div>
</div>
<!-- /.row -->
<script type="text/javascript">
    function setActiveExtensions(sender) {
        var activeExtensions = JSON.parse($('#ActiveExtensions').val());
        var index = activeExtensions.indexOf(sender.value);
        if (index > -1)
            activeExtensions.splice(index, 1);
        if (sender.checked)
            activeExtensions.push(sender.value);
        $('#ActiveExtensions').val(JSON.stringify(activeExtensions));
    }
    $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>