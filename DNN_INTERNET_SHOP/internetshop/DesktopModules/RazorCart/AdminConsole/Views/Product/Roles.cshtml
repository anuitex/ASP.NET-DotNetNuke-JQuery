@inherits System.Web.Mvc.WebViewPage<RazorCart.AdminConsole.Models.ProductModel>
@using System.Web.Mvc.Html;
@using RazorCart.Service.Data.ModelDataContext;

<!-- Bootstrap DatePicker CSS -->
<link href="@Href("~/DesktopModules/RazorCart/AdminConsole/Styles/bootstrap-datepicker.css?v=" + Model.ProductVersion)" rel="stylesheet" type="text/css" />
<!-- Select2 CSS -->
<link href="@Href("~/DesktopModules/RazorCart/AdminConsole/Styles/select2.min.css?v=" + Model.ProductVersion)" rel="stylesheet" type="text/css" />
<link href="@Href("~/DesktopModules/RazorCart/AdminConsole/Styles/select2-bootstrap.min.css?v=" + Model.ProductVersion)" rel="stylesheet" type="text/css" />
<!-- Bootstrap DatePicker JavaScript -->
<script src="@Href("~/DesktopModules/RazorCart/AdminConsole/Scripts/bootstrap-datepicker.min.js?v=" + Model.ProductVersion)" type="text/javascript"></script>
<!-- Conditionize JS -->
<script src="@Href("~/DesktopModules/RazorCart/AdminConsole/Scripts/conditionize.jquery.js?v=" + Model.ProductVersion)" type="text/javascript"></script>
<!-- Select2 JavaScript -->
<script src="@Href("~/DesktopModules/RazorCart/AdminConsole/Scripts/select2.min.js?v=" + Model.ProductVersion)" type="text/javascript"></script>

<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Product: @Model.Product.ModelName</h1>
    </div>
    <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
<div class="row">
    <div class="col-lg-12">
        <form class="form-horizontal" method="post" action="@Url.Action(ViewContext.RouteData.Values["action"].ToString(), "Product", new { StoreID = Model.StoreID, ProductID = Model.Product.ProductID })" autocomplete="off">
            @Html.Partial("_ProductMenu")
            @if (Model.Submitted)
            {
                <div class="alert alert-success alert-dismissable">
                    <span class="close" data-dismiss="alert" aria-label="close">×</span>
                    @Model.SaveMessage
                </div>
            }
            <div class="panel-group" id="accordion">
                <div class="lead">
                    <a href="#" class="btn btn-default" data-toggle="collapse-all" data-target="#accordion .panel-collapse">
                        Collapse All
                    </a>
                </div>
                <!-- Add Roles(s) -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="pull-right">
                            <div class="checkbox" style="padding-top: 0;">
                                <label>
                                    @Html.CheckBox("AddRolesEffectiveInCart", Model.ProductII.AddRolesEffectiveInCart, new { @onchange = "checkBoxChange(this);" }) Effective On Add To Cart
                                    <span class="rc-control">
                                        <i class="rc-icon glyphicon glyphicon-checkbox" aria-hidden="true"></i>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <a data-toggle="collapse" href="#collapseAddRoles">
                            <h4 class="panel-title">Add Role(s)</h4>
                        </a>
                    </div>
                    <!-- /.panel-heading -->
                    <div id="collapseAddRoles" class="panel-collapse collapse in">
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th style="min-width: 30px;">
                                                <div class="checkbox">
                                                    <label>
                                                        <input type="checkbox" id="chkAllAddRoles" />
                                                        <span class="rc-control">
                                                            <i class="rc-icon glyphicon glyphicon-checkbox" aria-hidden="true"></i>
                                                        </span>
                                                    </label>
                                                </div>
                                            </th>
                                            <th style="width: 20%; min-width: 200px; vertical-align: middle;">Role</th>
                                            <th style="width: 25%; min-width: 260px; vertical-align: middle;">Type</th>
                                            <th style="width: 25%; min-width: 160px; vertical-align: middle;">Expire</th>
                                            <th style="width: 30%; min-width: 310px; vertical-align: middle;">Level</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var role in Model.PortalRoles)
                                        {
                                            ProductManageRole manageRole = Model.ProductManageRoles.FirstOrDefault(r => r.Action == RoleManageAction.Add && r.RoleID.ToString() == role.Value);
                                            bool selected;
                                            if (!(selected = manageRole != null)) { manageRole = new ProductManageRole(); }
                                            <tr>
                                                <td>
                                                    <div class="checkbox">
                                                        <label>
                                                            @Html.CheckBox("chkAddRole_" + role.Value, selected, new { @onchange = "checkBoxChange(this);" })
                                                            <span class="rc-control">
                                                                <i class="rc-icon glyphicon glyphicon-checkbox" aria-hidden="true"></i>
                                                            </span>
                                                        </label>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-group">
                                                        <label style="padding-top: 7px; cursor: pointer;" for="@("chkAddRole_" + role.Value)">@role.Text</label>
                                                        @Html.Hidden("hdnAddRoleName_" + role.Value, role.Text)
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-horizontal" data-show="conditional" data-cond-option="@("chkAddRole_" + role.Value)" data-cond-value="true" data-cond-destroy="true" style="display: none;">
                                                        <div class="radio radio-inline" style="padding-left: 0; margin: 0 10px 0 0;">
                                                            <label>
                                                                @Html.RadioButton("rbAddRoleExpireType_" + role.Value, "None", manageRole.Type == RoleManageType.None || manageRole.Type == default(RoleManageType))
                                                                <span class="rc-control">
                                                                    <i class="rc-icon glyphicon glyphicon-radio" aria-hidden="true"></i>
                                                                </span>
                                                                None
                                                            </label>
                                                        </div>
                                                        <div class="radio radio-inline" style="padding-left: 0; margin: 0 10px 0 0;">
                                                            <label>
                                                                @Html.RadioButton("rbAddRoleExpireType_" + role.Value, "Days", manageRole.Type == RoleManageType.Days)
                                                                <span class="rc-control">
                                                                    <i class="rc-icon glyphicon glyphicon-radio" aria-hidden="true"></i>
                                                                </span>
                                                                Days
                                                            </label>
                                                        </div>
                                                        <div class="radio radio-inline" style="padding-left: 0; margin: 0 10px 0 0;">
                                                            <label>
                                                                @Html.RadioButton("rbAddRoleExpireType_" + role.Value, "Date", manageRole.Type == RoleManageType.Date)
                                                                <span class="rc-control">
                                                                    <i class="rc-icon glyphicon glyphicon-radio" aria-hidden="true"></i>
                                                                </span>
                                                                Date
                                                            </label>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-inline">
                                                        <div class="input-group" data-show="conditional" data-cond-option="@("rbAddRoleExpireType_" + role.Value)" data-cond-value="Days" style="display: none;">
                                                            @Html.TextBox("txtAddRoleExpireDays_" + role.Value, manageRole.ExpireDays > 0 ? manageRole.ExpireDays.ToString() : string.Empty, new { @class = "form-control", @placeholder = "# of Days", @required = "required", @type = "number", @min = "1", @style = "max-width: 130px;" })
                                                            <span class="input-group-addon">
                                                                <span class="fa fa-calculator"></span>
                                                            </span>
                                                        </div>
                                                        <div class="input-daterange" data-provide="datepicker" data-date-format="@Model.ShortDateFormat.ToLower()" data-date-autoclose="true" data-date-clear-btn="true" data-date-today-highlight="true"
                                                             data-show="conditional" data-cond-option="@("rbAddRoleExpireType_" + role.Value)" data-cond-value="Date" style="display: none;">
                                                            <div class="input-group">
                                                                @Html.TextBox("txtAddRoleExpireStart_" + role.Value, manageRole.StartDate > System.Data.SqlTypes.SqlDateTime.MinValue.Value ? manageRole.StartDate.ToString(Model.ShortDateFormat) : string.Empty, new { @class = "form-control", @placeholder = "Start Date", @style = "max-width: 130px;" })
                                                                <span class="input-group-addon">
                                                                    <span class="glyphicon glyphicon-calendar"></span>
                                                                </span>
                                                            </div>
                                                            <br />
                                                            <div class="input-group">
                                                                @Html.TextBox("txtAddRoleExpireEnd_" + role.Value, manageRole.EndDate > System.Data.SqlTypes.SqlDateTime.MinValue.Value ? manageRole.EndDate.ToString(Model.ShortDateFormat) : string.Empty, new { @class = "form-control", @placeholder = "End Date", @style = "max-width: 130px;" })
                                                                <span class="input-group-addon">
                                                                    <span class="glyphicon glyphicon-calendar"></span>
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-horizontal" data-show="conditional" data-cond-option="@("chkAddRole_" + role.Value)" data-cond-value="true" style="display: none;">
                                                        @Html.ListBox("ddlAddRoleLevel_" + role.Value, Model.ProductVariantList.ContainsKey(manageRole.ID) ? Model.ProductVariantList[manageRole.ID] : Model.DefaultProductVariantList, new { @required = "required" })
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- /.panel-body -->
                    </div>
                </div>
                <!-- /.panel -->
                <!-- Remove Roles(s) -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="pull-right">
                            <div class="checkbox" style="padding-top: 0;">
                                <label>
                                    @Html.CheckBox("RemoveRolesEffectiveInCart", Model.ProductII.RemoveRolesEffectiveInCart, new { @onchange = "checkBoxChange(this);" }) Effective On Add To Cart
                                    <span class="rc-control">
                                        <i class="rc-icon glyphicon glyphicon-checkbox" aria-hidden="true"></i>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <a data-toggle="collapse" href="#collapseRemoveRoles">
                            <h4 class="panel-title">Remove Role(s)</h4>
                        </a>
                    </div>
                    <!-- /.panel-heading -->
                    <div id="collapseRemoveRoles" class="panel-collapse collapse">
                        <div class="panel-body">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th style="min-width: 30px;">
                                            <div class="checkbox">
                                                <label>
                                                    <input type="checkbox" id="chkAllRemoveRoles" />
                                                    <span class="rc-control">
                                                        <i class="rc-icon glyphicon glyphicon-checkbox" aria-hidden="true"></i>
                                                    </span>
                                                </label>
                                            </div>
                                        </th>
                                        <th style="width: 100%; min-width: 200px; vertical-align: middle;">Role</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        foreach (var role in Model.PortalRoles)
                                        {
                                            ProductManageRole manageRole = Model.ProductManageRoles.FirstOrDefault(r => r.Action == RoleManageAction.Remove && r.RoleID.ToString() == role.Value);
                                            bool selected;
                                            if (!(selected = manageRole != null)) { manageRole = new ProductManageRole(); }
                                            <tr>
                                                <td>
                                                    <div class="checkbox">
                                                        <label>
                                                            <input type="checkbox" id="@("chkRemoveRole_" + role.Value)" name="@("chkRemoveRole_" + role.Value)" value="true" @(selected ? "Checked" : string.Empty) />
                                                            <span class="rc-control">
                                                                <i class="rc-icon glyphicon glyphicon-checkbox" aria-hidden="true"></i>
                                                            </span>
                                                        </label>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-group">
                                                        <label style="padding-top: 7px; cursor: pointer;" for="@("chkRemoveRole_" + role.Value)">@role.Text</label>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                        <!-- /.panel-body -->
                    </div>
                </div>
                <!-- /.panel -->
                <!-- Show/Hide Roles(s) -->
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <a data-toggle="collapse" href="#collapseShowHideRoles">
                            <h4 class="panel-title">Visibility by Role(s)</h4>
                        </a>
                    </div>
                    <!-- /.panel-heading -->
                    <div id="collapseShowHideRoles" class="panel-collapse collapse">
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th style="min-width: 30px;">
                                                <div class="checkbox">
                                                    <label>
                                                        <input type="checkbox" id="chkAllShowHideRoles" />
                                                        <span class="rc-control">
                                                            <i class="rc-icon glyphicon glyphicon-checkbox" aria-hidden="true"></i>
                                                        </span>
                                                    </label>
                                                </div>
                                            </th>
                                            <th style="width: 40%; min-width: 240px; vertical-align: middle;">Role</th>
                                            <th style="width: 60%; min-width: 240px; vertical-align: middle;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var role in Model.PortalRoles)
                                        {
                                            ProductVisibilityRole visibilityRole = Model.ProductVisibilityRoles.FirstOrDefault(vr => vr.RoleID.ToString() == role.Value);
                                            <tr>
                                                <td>
                                                    <div class="checkbox">
                                                        <label>
                                                            <input type="checkbox" id="@("chkVisibilityRole_" + role.Value)" name="@("chkVisibilityRole_" + role.Value)" value="true" @(visibilityRole != null ? "Checked" : string.Empty) />
                                                            <span class="rc-control">
                                                                <i class="rc-icon glyphicon glyphicon-checkbox" aria-hidden="true"></i>
                                                            </span>
                                                        </label>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-group">
                                                        <label style="padding-top: 7px; cursor: pointer;" for="@("chkVisibilityRole_" + role.Value)">@role.Text</label>
                                                        @Html.Hidden("hdnVisibilityRoleName_" + role.Value, role.Text)
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="form-horizontal" data-show="conditional" data-cond-option="@("chkVisibilityRole_" + role.Value)" data-cond-value="true" data-cond-destroy="true" style="display: none;">
                                                        <div class="radio radio-inline" style="padding-left: 0; margin: 0 10px 0 0;">
                                                            <label>
                                                                @Html.RadioButton("rbVisibilityRoleAction_" + role.Value, "Show", visibilityRole != null && visibilityRole.Action == RoleVisibilityType.Show)
                                                                <span class="rc-control">
                                                                    <i class="rc-icon glyphicon glyphicon-radio" aria-hidden="true"></i>
                                                                </span>
                                                                Show
                                                            </label>
                                                        </div>
                                                        <div class="radio radio-inline" style="padding-left: 0; margin: 0 10px 0 0;">
                                                            <label>
                                                                @Html.RadioButton("rbVisibilityRoleAction_" + role.Value, "Hide", visibilityRole != null && visibilityRole.Action == RoleVisibilityType.Hide)
                                                                <span class="rc-control">
                                                                    <i class="rc-icon glyphicon glyphicon-radio" aria-hidden="true"></i>
                                                                </span>
                                                                Hide
                                                            </label>
                                                        </div>
                                                        <div class="radio radio-inline" style="padding-left: 0; margin: 0 10px 0 0;">
                                                            <label>
                                                                @Html.RadioButton("rbVisibilityRoleAction_" + role.Value, "Disable", visibilityRole != null && visibilityRole.Action == RoleVisibilityType.Disable)
                                                                <span class="rc-control">
                                                                    <i class="rc-icon glyphicon glyphicon-radio" aria-hidden="true"></i>
                                                                </span>
                                                                Disable
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="form-horizontal" data-show="conditional" data-cond-option="@("rbVisibilityRoleAction_" + role.Value)" data-cond-value="Disable" style="display: none;">
                                                        <label style="padding-top: 7px; cursor: pointer;" for="@("chkVisibilityRole_" + role.Value)">Disable Message</label>
                                                        @Html.TextBox("txtVisibilityRoleMessage_" + role.Value, visibilityRole != null ? visibilityRole.Message : string.Empty, new { @class = "form-control", @placeholder = "Disable Message" })
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- /.panel-body -->
                    </div>
                </div>
                <!-- /.panel -->
            </div>
            <div class="form-group">
                <div class="col-sm-offset-3 col-sm-9">
                    <button type="submit" class="btn btn-primary"><i class="fa fa-check-square-o"></i> Save</button>
                    <a class="btn btn-default" href="@Url.Action("Index", "Product", new { StoreID = Model.StoreID })">Back</a>
                </div>
            </div>
        </form>
        <!-- /.form -->
    </div>
</div>
<!-- /.row -->
<script type="text/javascript">
    $(document).ready(function () {
        // Init Conditionize Form
        $('[data-show="conditional"]').conditionize();
        // Role Elements Functions
        $('#chkAllAddRoles').on('click', function () {
            var checked = $(this).prop('checked');
            $('input[name^="chkAddRole_"]').prop('checked', checked).trigger('change');
        });
        $('#chkAllRemoveRoles').on('click', function () {
            var checked = $(this).prop('checked');
            $('input[name^="chkRemoveRole_"]').prop('checked', checked).trigger('change');
        });
        $('#chkAllShowHideRoles').on('click', function () {
            var checked = $(this).prop('checked');
            $('input[name^="chkVisibilityRole_"]').prop('checked', checked).trigger('change');
        });
        $('.input-daterange').each(function () {
            var $range = $(this);
            var $inputs = $range.find('input[id^=txtAddRoleExpire]');
            var dateChange = function () {
                var dates = 0;
                $inputs.each(function () {
                    if (this.value) dates++;
                });
                if (dates) $inputs.removeAttr('required');
                else $inputs.attr('required', '');
            };
            $range.on('changeDate clearDate', function (e) {
                dateChange();
            });
            dateChange();
        });
        // Select-2
        $('[id^="ddlAddRoleLevel_"]').select2({
            width: '100%',
            theme: 'bootstrap',
            placeholder: "Select a product variant",
            ajax: {
                type: 'POST',
                url: '@Url.Action("ListVariants", "Product", new { StoreID = Model.StoreID, ProductID = Model.Product.ProductID })',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        'search[value]': params.term,
                        'length': 25,
                        'start': 0
                    };
                },
                processResults: function (data, params) {
                    var selected = this.$element.val().map(Number);
                    if (!selected.length)
                        data.data.unshift({ VariantID: -1, VariantGroup: 'Product Level', VariantName: 'No Variant(s)' });
                    return {
                        results: $.map(data.data, function (item) {
                            if ($.inArray(-1, selected) === -1) {
                                if ($.inArray(item.VariantID, selected) === -1) {
                                    return {
                                        id: item.VariantID,
                                        text: item.VariantGroup + ' > ' + item.VariantName
                                    };
                                }
                            }
                        })
                    };
                },
                cache: false
            },
            minimumInputLength: 0,
        });
    });
</script>